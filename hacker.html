<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>STOP ODLAV — Cyber Defense</title>
    <style>
        :root {
            --bg: #050608;
            --neon: #00FF9C;
            --accent: #7A60FF;
            --danger: #FF3B58;
            --soft: #0b0c0f;
            --glass: rgba(255, 255, 255, 0.03);
            --mono: 'Segoe UI Mono', 'Roboto Mono', ui-monospace, SFMono-Regular, monospace;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: radial-gradient(ellipse at 10% 10%, rgba(122, 96, 255, 0.07), transparent 8%), radial-gradient(ellipse at 95% 90%, rgba(0, 255, 156, 0.03), transparent 10%), var(--bg);
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            color: #dbe;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px;
            box-sizing: border-box;
        }

        /* Stage */
        .stage {
            width: 100%;
            max-width: 1100px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(2, 6, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.04);
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        /* left panel: HUD */
        .hud {
            padding: 18px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.015), rgba(255, 255, 255, 0.01));
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent), var(--neon));
            box-shadow: 0 6px 20px rgba(122, 96, 255, 0.12), inset 0 -4px 12px rgba(0, 0, 0, 0.25);
            font-weight: 700;
            color: #041;
            font-family: var(--mono);
            letter-spacing: 0.6px;
            overflow: hidden;
            /* ensures image doesn't overflow */
        }

        .logo img {
            width: 80%;
            /* adjust size to fit inside the div */
            height: 80%;
            object-fit: contain;
            display: block;
        }


        .title h1 {
            margin: 0;
            font-size: 18px;
            color: #dffbff;
            letter-spacing: 0.6px;
        }

        .subtitle {
            font-size: 12px;
            color: #a7d9d5;
            margin-top: 2px;
        }

        .circular-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 220px;
            position: relative;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.02));
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .timer-ring {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: conic-gradient(var(--neon) 0deg, rgba(255, 255, 255, 0.03) 0deg);
            position: relative;
            box-shadow: 0 6px 18px rgba(0, 255, 156, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .timer-inner {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.45), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .timer-inner strong {
            font-size: 26px;
            color: var(--neon);
            letter-spacing: 1px;
        }

        .timer-inner small {
            font-size: 12px;
            color: #9fffd0;
            opacity: 0.9;
        }

        /* progress */
        .progress-box {
            padding: 12px;
            border-radius: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .progress-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            color: #bff9e5;
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.4);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--neon), var(--accent));
            box-shadow: 0 6px 18px rgba(122, 96, 255, 0.06) inset;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #042;
            font-weight: 700;
            font-size: 12px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 6px;
        }

        .stat {
            background: var(--glass);
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            color: #bfe;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }

        .stat strong {
            font-size: 18px;
            color: var(--neon);
            font-family: var(--mono);
        }

        /* right panel: playfield */
        .playfield {
            padding: 18px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(0, 0, 0, 0.03));
            border: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-height: 380px;
            position: relative;
            overflow: hidden;
        }

        .hud-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .alert {
            background: linear-gradient(90deg, rgba(255, 59, 88, 0.08), rgba(255, 255, 255, 0.01));
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 59, 88, 0.08);
            display: flex;
            gap: 10px;
            align-items: center;
            color: #ffd4d6;
            font-size: 13px;
        }

        /* letter card */
        .letter-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
        }

        .letter-frame {
            width: 320px;
            max-width: 80%;
            height: 220px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.03);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), inset 0 -8px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .letter {
            font-family: var(--mono);
            font-size: 120px;
            color: var(--neon);
            text-shadow: 0 6px 30px rgba(0, 255, 156, 0.06);
            user-select: none;
        }

        /* corrupted/glitch */
        .corrupt {
            animation: glitch1 0.28s infinite steps(2, end);
            filter: contrast(160%) saturate(120%);
            text-shadow: -6px 0 var(--accent), 6px 4px rgba(0, 255, 156, 0.08);
        }

        .corrupt::after {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            mix-blend-mode: screen;
            background: linear-gradient(90deg, transparent 20%, rgba(122, 96, 255, 0.02) 50%, transparent 80%);
            opacity: 0.6;
        }

        @keyframes glitch1 {
            0% {
                transform: translate(0, 0) skewX(0);
                opacity: 1;
            }

            20% {
                transform: translate(-2px, 1px) skewX(-2deg);
                opacity: 0.95;
            }

            40% {
                transform: translate(2px, -2px) skewX(1deg);
                opacity: 1;
            }

            60% {
                transform: translate(-1px, 2px) skewX(-1deg);
                opacity: 0.9;
            }

            80% {
                transform: translate(1px, -1px) skewX(2deg);
                opacity: 1;
            }

            100% {
                transform: translate(0, 0) skewX(0);
                opacity: 1;
            }
        }

        /* input / keyboard */
        .input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            flex-direction: column;
        }

        .type-input {
            width: 360px;
            max-width: 92%;
            height: 70px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--mono);
            font-size: 34px;
            letter-spacing: 8px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--neon);
            box-shadow: 0 8px 30px rgba(0, 255, 156, 0.03) inset;
        }

        .type-input:focus {
            outline: none;
            box-shadow: 0 0 30px rgba(0, 255, 156, 0.06);
        }

        .kbd {
            width: 100%;
            display: flex;
            flex-direction: column;
            /* stack rows vertically */
            gap: 8px;
            justify-content: center;
            align-items: center;
            /* center each row */
            padding: 8px;
            user-select: none;
        }

        .keyrow {
            display: flex;
            flex-direction: row;
            /* make letters go horizontally */
            justify-content: center;
            gap: 8px;
        }


        .key {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #e8fff6;
            font-family: var(--mono);
            border: 1px solid rgba(255, 255, 255, 0.02);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        }

        .key:active {
            transform: translateY(2px);
        }

        /* overlays */
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(1, 2, 3, 0.65), rgba(0, 0, 0, 0.78));
            z-index: 40;
            padding: 24px;
            transition: opacity 300ms ease, transform 300ms ease;
        }

        .dialog {
            width: 100%;
            max-width: 780px;
            background: linear-gradient(180deg, rgba(10, 12, 15, 0.95), rgba(255, 255, 255, 0.01));
            border-radius: 12px;
            padding: 22px;
            color: #d8fff1;
            border: 1px solid rgba(255, 255, 255, 0.03);
            box-shadow: 0 14px 60px rgba(0, 0, 0, 0.7);
        }

        .dialog h2 {
            margin: 0;
            font-family: var(--mono);
            color: var(--neon);
            font-size: 20px;
        }

        .dialog p {
            margin-top: 10px;
            line-height: 1.45;
            color: #cdefe3;
            font-size: 15px;
        }

        .btn {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 10px 16px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--neon), var(--accent));
            color: #041;
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-family: var(--mono);
            box-shadow: 0 10px 30px rgba(122, 96, 255, 0.12);
        }

        .btn.ghost {
            background: transparent;
            color: #cdeff0;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: none;
        }

        .muted {
            color: #97e7d3;
            font-size: 13px;
        }

        /* win/lose */
        .result-card {
            width: 100%;
            max-width: 640px;
            padding: 22px;
            border-radius: 12px;
            text-align: center;
        }

        .result-card h1 {
            font-family: var(--mono);
            font-size: 36px;
            margin: 0 0 8px 0;
            color: var(--neon);
        }

        .result-card p {
            color: #d6fff1;
            margin: 6px 0 16px;
            font-size: 15px;
        }

        .confetti {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 30;
        }

        /* small screens adjustments (tablet) */
        @media (max-width:960px) {
            .stage {
                grid-template-columns: 1fr;
                padding: 12px;
            }

            .title h1 {
                font-size: 16px;
            }

            .circular-timer {
                height: 180px;
            }

            .letter {
                font-size: 96px;
            }

            .letter-frame {
                height: 180px;
            }

            .type-input {
                height: 60px;
                font-size: 28px;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="stage" role="application" aria-label="Stop Odlav cyber defense game">
            <!-- LEFT HUD -->
            <div class="hud">
                <div class="title">
                    <div class="logo">
                        <img src="images/shield.png" alt="Shield Logo" />
                    </div>
                    <div>
                        <h1>Shield S26</h1>
                        <div class="subtitle">DEFEND &amp; SECURE — TYPE THE NEXT LETTER</div>
                    </div>
                </div>

                <div class="circular-timer" aria-hidden>
                    <div id="perRing" class="timer-ring" aria-hidden>
                        <div class="timer-inner">
                            <strong id="perNumber">5</strong>
                            <small>PER-LETTER</small>
                        </div>
                    </div>
                </div>

                <div class="progress-box">
                    <div class="progress-label"><span>Firewall Strength</span><span id="progressText">0 / 10</span>
                    </div>
                    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="10" aria-valuenow="0">
                        <div id="progressFill" class="progress-fill">0</div>
                    </div>

                    <div class="stat-grid" style="margin-top:10px;">
                        <div class="stat"><small>TIME LEFT</small><strong id="timeLeft">60s</strong></div>
                        <div class="stat"><small>LETTERS NEEDED</small><strong id="need">15</strong></div>
                    </div>
                </div>

                <div style="margin-top:auto;">
                    <div class="muted">Security Level: <strong id="secLevel">Green</strong></div>
                    <div style="height:12px;"></div>
                    <button id="muteBtn" class="btn ghost" style="width:100%;">Mute Sounds</button>
                </div>
            </div>

            <!-- RIGHT PLAYFIELD -->
            <div class="playfield">
                <div class="hud-top">
                    <div class="alert">🚨 <strong>INTRUSION ACTIVE</strong> — Odlav attempting remote access</div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <div class="muted">Shield S26</div>
                    </div>
                </div>

                <div class="letter-card" aria-live="polite">
                    <div class="letter-frame" id="letterFrame" role="img" aria-label="Current letter">
                        <div id="letter" class="letter">*</div>
                    </div>

                    <div class="input-row">
                        <div id="typeInput" class="type-input" tabindex="0" contenteditable="true"
                            aria-label="Type next letter" role="textbox"></div>
                        <div class="kbd" id="keyboard"></div>
                    </div>
                </div>

                <!-- credits / hint -->
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div class="muted">Hint: If letter is <strong>corrupted</strong> it flickers — be extra sharp!</div>
                    <div style="display:flex;gap:8px;">
                        <button id="restartBtn" class="btn ghost">Restart</button>
                        <button id="startBtn" class="btn">Start</button>
                    </div>
                </div>

                <!-- overlays -->
                <div id="introOverlay" class="overlay">
                    <div class="dialog" id="introStep1">
                        <h2>SECURITY ALERT — Odlav is attacking!</h2>
                        <p>Adlov, a dangerous hacker, is trying to steal all your money, but your best friend <em>Ado
                                Adi</em> left you a secret message to help stop him!</p>
                        <div style="display:flex;justify-content:flex-end;margin-top:12px;">
                            <button id="readMessageBtn" class="btn">Read message</button>
                        </div>
                    </div>

                    <div class="dialog" id="introStep2" style="display:none;">
                        <h2>SECURITY ALERT — Odlav is attacking!</h2>
                        <p style="font-style:italic; color:#bff8e9">
                            “My best friends, we are being attacked. I am counting on you to defeat the hacker and save the money. You just
                            need to be smart, fast and be you.”
                        </p>
                        <p>
                            Shield S26 program <strong>*Instructions*</strong>: <br>Each screen will show a <strong>letter</strong>
                            <strong>and a sign</strong> next
                            to it:
                        </p>
                        <ul>
                            <li>If the sign is <strong>+</strong>, type the letter that comes <strong>after</strong> the
                                shown letter alphabetically.</li>
                            <li>If the sign is <strong>-</strong>, type the letter that comes <strong>before</strong>
                                the shown letter alphabetically.</li>
                        </ul>
                        <p>
                            <br>You have
                            <strong>60 seconds</strong> total and <strong>5 seconds</strong> per letter. Crack 15
                            codes to prevent the hack!
                        </p>
                        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:12px;">
                            <button id="introStart" class="btn">Begin Defense</button>
                            <button id="introClose" class="btn ghost">Dismiss</button>
                        </div>
                    </div>
                </div>


                <div id="resultOverlay" class="overlay" style="display:none;">
                    <div id="resultCard" class="result-card dialog">
                        <!-- populated dynamically -->
                    </div>
                </div>

                <div id="confetti" class="confetti" aria-hidden></div>

            </div>
        </div>
    </div>

    <script>
        /* =========================
           Game Logic for Stop Odlav
           ========================= */

        (() => {
            // DOM references
            const startBtn = document.getElementById('startBtn');
            const introOverlay = document.getElementById('introOverlay');
            const introStart = document.getElementById('introStart');
            const introClose = document.getElementById('introClose');
            const letterEl = document.getElementById('letter');
            const letterFrame = document.getElementById('letterFrame');
            const typeInput = document.getElementById('typeInput');
            const perNumber = document.getElementById('perNumber');
            const perRing = document.getElementById('perRing');
            const timeLeftEl = document.getElementById('timeLeft');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const needEl = document.getElementById('need');
            const secLevel = document.getElementById('secLevel');
            const keyboardEl = document.getElementById('keyboard');
            const resultOverlay = document.getElementById('resultOverlay');
            const resultCard = document.getElementById('resultCard');
            const restartBtn = document.getElementById('restartBtn');
            const introOverlayBtn = document.getElementById('introStart');
            const muteBtn = document.getElementById('muteBtn');

            // game config
            const TOTAL_TIME = 60; // seconds
            const PER_TIME = 5; // per letter seconds
            const TARGET = 15;
            const CORRUPT_PROB = 0.18; // fraction of letters that are corrupted

            // state
            let totalTimer = null;
            let perTimer = null;
            let timeLeft = TOTAL_TIME;
            let perLeft = PER_TIME;
            let progress = 0;
            let currentLetter = 'A';
            let running = false;
            let soundOn = true;
            let lettersAsked = 0;
            let currentSymbol = '+'; // either '+' or '-'

            const readMessageBtn = document.getElementById('readMessageBtn');
            const introStep1 = document.getElementById('introStep1');
            const introStep2 = document.getElementById('introStep2');

            // Step 1 → Step 2
            readMessageBtn.addEventListener('click', () => {
                introStep1.style.display = 'none';
                narrateDialog();
                introStep2.style.display = 'block';
            });


            function narrateDialog() {
                // if (!('speechSynthesis' in window)) return; // check browser support


                textToSpeak = "My best friends, we are being attacked. I am counting on you to defeat the hacker and save the money. Use my program: Shield S26 . You just need to be smart and fast. Read carefully the instructions that i left for you";


                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.rate = 0.8;
                utterance.pitch = 0.1;
                utterance.volume = 1;     // full volume
                utterance.lang = 'en-US'; // language

                window.speechSynthesis.cancel(); // cancel any existing speech
                window.speechSynthesis.speak(utterance);
            }

            // audio simple tones using WebAudio
            const AudioC = window.AudioContext || window.webkitAudioContext;
            const audioCtx = AudioC ? new AudioC() : null;
            function tone(freq, dur = 0.12, vol = 0.03) {
                if (!audioCtx || !soundOn) return;
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'sine';
                o.frequency.value = freq;
                g.gain.value = vol;
                o.connect(g); g.connect(audioCtx.destination);
                o.start();
                o.stop(audioCtx.currentTime + dur);
            }

            // helper: random letter A-Z
            function randLetter() {
                const code = Math.floor(Math.random() * 26) + 65;
                return String.fromCharCode(code);
            }
            // compute next letter in alphabet with wrap Z->A
            function nextLetter(letter) {
                const code = letter.charCodeAt(0);
                return String.fromCharCode(((code - 65 + 1) % 26) + 65);
            }

            // show letter, possibly corrupted
            function displayNewLetter() {
                lettersAsked++;
                perLeft = PER_TIME;
                updatePerUI();

                // pick new random letter
                currentLetter = randLetter();

                // pick random symbol + or -
                currentSymbol = Math.random() < 0.5 ? '+' : '-';

                // show letter and symbol
                letterEl.textContent = currentLetter + currentSymbol;

                // decide corrupted (optional)
                const corrupted = Math.random() < CORRUPT_PROB;
                if (corrupted) {
                    letterEl.classList.add('corrupt');
                    letterFrame.classList.add('glitch-frame');
                } else {
                    letterEl.classList.remove('corrupt');
                    letterFrame.classList.remove('glitch-frame');
                }

                // visual pulse
                letterFrame.animate([
                    { transform: 'scale(0.98) rotate(-0.3deg)', opacity: 0.96 },
                    { transform: 'scale(1.02) rotate(0.3deg)', opacity: 1 }
                ], { duration: 420, easing: 'ease-out', iterations: 1 });

                resetPerTimer();
            }


            // Per-letter timer UI update (conic fill)
            function updatePerUI() {
                perNumber.textContent = perLeft;
                const fraction = perLeft / PER_TIME;
                const deg = Math.max(0, Math.floor(fraction * 360));
                perRing.style.background = `conic-gradient(${getPerColor(fraction)} ${deg}deg, rgba(255,255,255,0.03) ${deg}deg)`;
            }
            function getPerColor(frac) {
                if (frac > 0.6) return 'var(--neon)';
                if (frac > 0.3) return 'var(--accent)';
                return 'var(--danger)';
            }

            // Total timer update
            function updateTotalUI() {
                timeLeftEl.textContent = timeLeft + 's';
                // security level
                const sec = Math.max(0, Math.ceil((TARGET - progress) / TARGET * 100));
                if (timeLeft <= 10) secLevel.textContent = 'CRITICAL';
                else if (progress >= TARGET / 2) secLevel.textContent = 'GREEN';
                else secLevel.textContent = 'YELLOW';
            }

            // progress update
            function updateProgressUI() {
                progressText.textContent = `${progress} / ${TARGET}`;
                const pct = Math.min(100, Math.round((progress / TARGET) * 100));
                progressFill.style.width = pct + '%';
                progressFill.textContent = progress > 0 ? progress : '';
                progressFill.setAttribute('aria-valuenow', progress);
            }

            // start game
            function startGame() {
                if (running) return;
                running = true;
                progress = 0;
                timeLeft = TOTAL_TIME;
                lettersAsked = 0;
                updateProgressUI();
                updateTotalUI();
                displayNewLetter();

                // total timer ticks every second
                totalTimer = setInterval(() => {
                    timeLeft--;
                    updateTotalUI();
                    if (timeLeft <= 0) {
                        endGame(false);
                    }
                }, 1000);

                // initial focus
                focusInput();
                playSoundStart();
            }

            function resetPerTimer() {
                if (perTimer) clearInterval(perTimer);
                perTimer = setInterval(() => {
                    perLeft -= 1;
                    updatePerUI();
                    if (perLeft <= 0) {
                        // timeout: treat as wrong, new letter
                        onWrong('timeout');
                    }
                }, 1000);
            }

            function stopPerTimer() {
                if (perTimer) { clearInterval(perTimer); perTimer = null; }
            }

            function stopTotalTimer() {
                if (totalTimer) { clearInterval(totalTimer); totalTimer = null; }
            }

            function endGame(won) {
                running = false;
                stopPerTimer();
                stopTotalTimer();
                showResult(won);
            }

            // feedbacks
            function playSoundStart() { tone(600, 0.12, 0.05); tone(900, 0.06, 0.03); }
            function playCorrect() { tone(1000, 0.06, 0.05); }
            function playWrong() { tone(160, 0.16, 0.06); }
            function playVictory() { tone(1200, 0.14, 0.06); tone(950, 0.12, 0.05); tone(1400, 0.09, 0.04); }

            // handle correct
            function onCorrect() {
                playCorrect();
                progress++;
                updateProgressUI();
                // success animation
                letterEl.animate([
                    { transform: 'translateY(0) scale(1)', opacity: 1 },
                    { transform: 'translateY(-8px) scale(1.06)', opacity: 1 },
                ], { duration: 220, easing: 'ease-out', fill: 'forwards' });

                // short green flash
                letterFrame.animate([{ backgroundColor: 'rgba(0,255,156,0.06)' }, { backgroundColor: 'transparent' }], { duration: 320 });

                if (progress >= TARGET) {
                    endGame(true);
                    return;
                }
                // next letter after a small delay
                stopPerTimer();
                setTimeout(() => displayNewLetter(), 220);
            }

            // handle wrong / timeout
            function onWrong(reason = 'wrong') {
                playWrong();
                // red glitch flash
                letterFrame.animate([{ filter: 'hue-rotate(0deg)' }, { filter: 'hue-rotate(320deg)' }, { filter: 'hue-rotate(0deg)' }], { duration: 420 });
                // shake
                letterFrame.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-8px)' }, { transform: 'translateX(6px)' }, { transform: 'translateX(0)' }], { duration: 300 });

                stopPerTimer();
                // show a quick "Odlav hacks deeper" overlay text
                const note = document.createElement('div');
                note.textContent = reason === 'timeout' ? 'Time out — Odlav probing...' : 'Incorrect — Odlav slips in...';
                note.style.position = 'absolute';
                note.style.bottom = '18px';
                note.style.left = '50%';
                note.style.transform = 'translateX(-50%)';
                note.style.padding = '8px 12px';
                note.style.borderRadius = '8px';
                note.style.background = 'linear-gradient(90deg, rgba(255,59,88,0.06), rgba(0,0,0,0.2))';
                note.style.color = '#ffdfe1';
                note.style.zIndex = '20';
                letterFrame.appendChild(note);
                setTimeout(() => note.remove(), 900);

                // next letter after short delay
                setTimeout(() => displayNewLetter(), 450);
            }

            // show result overlay
            function showResult(win) {
                resultOverlay.style.display = 'flex';
                resultCard.innerHTML = '';
                if (win) {
                    playVictory();
                    resultCard.innerHTML = `
        <h1>ACCESS BLOCKED</h1>
        <p>You've stopped Odlav and secured the account! Firewall integrity reached ${progress}/${TARGET}.</p>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button id="replayYes" class="btn">Play Again</button>
          <button id="replayNo" class="btn ghost">Exit</button>
        </div>
      `;
                    // confetti
                    runConfetti();
                } else {
                    resultCard.innerHTML = `
        <h1 style="color:var(--danger)">ACCOUNT COMPROMISED</h1>
        <p>Odlav has breached the defenses. You cracked ${progress}/${TARGET} codes before time ran out.</p>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button id="replayYes" class="btn">Try Again</button>
          <button id="replayNo" class="btn ghost">Exit</button>
        </div>
      `;
                    // glitchy background animation
                    resultCard.animate([{ filter: 'hue-rotate(0deg)' }, { filter: 'hue-rotate(30deg)' }, { filter: 'hue-rotate(-20deg)' }, { filter: 'hue-rotate(0deg)' }], { duration: 1400, iterations: 4 });
                }

                document.getElementById('replayYes').addEventListener('click', () => {
                    resultOverlay.style.display = 'none';
                    resetGame();
                    startGame();
                });
                document.getElementById('replayNo').addEventListener('click', () => {
                    resultOverlay.style.display = 'none';
                    resetGame();
                });
            }

            function resetGame() {
                running = false;
                stopPerTimer();
                stopTotalTimer();
                progress = 0;
                timeLeft = TOTAL_TIME;
                perLeft = PER_TIME;
                updateProgressUI();
                updateTotalUI();
                perRing.style.background = `conic-gradient(var(--neon) 360deg, rgba(255,255,255,0.03) 0deg)`;
                letterEl.textContent = 'A';
                letterEl.classList.remove('corrupt');
                resultOverlay.style.display = 'none';
                clearConfetti();
            }

            // input handling: typed letter must be nextLetter(currentLetter)
            function handleAnswer(ch) {
                if (!running) return;
                if (!ch || typeof ch !== 'string') return;
                ch = ch.trim().toUpperCase().slice(0, 1);
                if (!ch.match(/[A-Z]/)) return;

                // determine expected letter
                let expected;
                if (currentSymbol === '+') {
                    expected = nextLetter(currentLetter);
                } else {
                    expected = prevLetter(currentLetter);
                }

                if (ch === expected) {
                    onCorrect();
                } else {
                    onWrong('wrong');
                }

                clearInputField();
            }

            function prevLetter(letter) {
                const code = letter.charCodeAt(0);
                return String.fromCharCode(((code - 65 + 25) % 26) + 65); // wrap A->Z
            }


            // Friendly focus and capturing input
            function focusInput() {
                typeInput.focus();
            }

            // build on-screen keyboard
            function buildKeyboard() {
                const layout = [
                    "QWERTYUIOP",
                    "ASDFGHJKL",
                    "ZXCVBNM"
                ];
                const keyboardEl = document.getElementById('keyboard');
                keyboardEl.innerHTML = '';
                layout.forEach(row => {
                    const rowEl = document.createElement('div');
                    rowEl.className = 'keyrow';
                    row.split('').forEach(ch => {
                        const k = document.createElement('div');
                        k.className = 'key';
                        k.textContent = ch;
                        k.addEventListener('click', () => handleAnswer(ch));
                        rowEl.appendChild(k);
                    });
                    keyboardEl.appendChild(rowEl);
                });
            }


            // input element handling (contenteditable)
            function clearInputField() {
                typeInput.textContent = '';
            }
            typeInput.addEventListener('keydown', (e) => {
                if (!running) return;
                // handle single key entries
                if (e.key && e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
                    e.preventDefault();
                    handleAnswer(e.key);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // try to read what's inside
                    const val = typeInput.textContent || '';
                    if (val) handleAnswer(val);
                } else if (e.key === 'Backspace') {
                    // allow deletion for niceness but not necessary
                }
            });


            // Start / intro actions
            startBtn.addEventListener('click', () => {
                introOverlay.style.display = 'flex';
            });
            introStart.addEventListener('click', () => {
                introOverlay.style.display = 'none';
                resetGame();
                startGame();
            });
            introClose.addEventListener('click', () => {
                introOverlay.style.display = 'none';
            });

            restartBtn.addEventListener('click', () => {
                resetGame();
                introOverlay.style.display = 'flex';
            });

            // mute
            muteBtn.addEventListener('click', () => {
                soundOn = !soundOn;
                muteBtn.textContent = soundOn ? 'Mute Sounds' : 'Unmute';
                tone(600, 0.06, 0.03);
            });

            // helper: show confetti (simple)
            let confettiTimer = null;
            function runConfetti() {
                const mounts = document.getElementById('confetti');
                mounts.innerHTML = '';
                const colors = ['#00FF9C', '#7A60FF', '#00FFD0', '#FF6B9A'];
                for (let i = 0; i < 60; i++) {
                    const el = document.createElement('div');
                    el.style.position = 'absolute';
                    const size = Math.random() * 10 + 6;
                    el.style.width = el.style.height = size + 'px';
                    el.style.left = Math.random() * 100 + '%';
                    el.style.top = '-10%';
                    el.style.borderRadius = '2px';
                    el.style.background = colors[Math.floor(Math.random() * colors.length)];
                    el.style.opacity = 0.95;
                    el.style.transform = `rotate(${Math.random() * 360}deg)`;
                    el.style.zIndex = 50;
                    mounts.appendChild(el);
                    const fall = el.animate([
                        { transform: `translateY(0) rotate(0)`, opacity: 1 },
                        { transform: `translateY(${Math.random() * 120 + 80}vh) rotate(${Math.random() * 720}deg)`, opacity: 0.9 }
                    ], { duration: 1800 + Math.random() * 1600, delay: Math.random() * 300, easing: 'cubic-bezier(.2,.8,.2,1)' });
                    fall.onfinish = () => el.remove();
                }
                // clear after some time
                if (confettiTimer) clearTimeout(confettiTimer);
                confettiTimer = setTimeout(() => { clearConfetti(); }, 4000);
            }
            function clearConfetti() { const mounts = document.getElementById('confetti'); mounts.innerHTML = ''; if (confettiTimer) { clearTimeout(confettiTimer); confettiTimer = null; } }

            // initialize UI
            (function init() {
                updateProgressUI();
                updateTotalUI();
                buildKeyboard();
                clearInputField();
                // add keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ') {
                        e.preventDefault();
                        if (!running) {
                            resetGame();
                            startGame();
                        }
                    }
                });
                // Start with intro visible
                introOverlay.style.display = 'flex';
                // make input focusable
                typeInput.addEventListener('focus', () => typeInput.classList.add('focused'));
                typeInput.addEventListener('blur', () => typeInput.classList.remove('focused'));
            })();

        })();
    </script>
</body>

</html>